name: Export dashboard report to BigQuery

on:
  workflow_dispatch:
  schedule:
    - cron:  '10 * * * *'

jobs:
  export:
    name: Export dashboard report to BigQuery

    runs-on: ubuntu-20.04
    container: google/cloud-sdk:latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - uses: DFE-Digital/github-actions/set-arm-environment-variables@master
        with:
          azure-credentials: ${{ inputs.azure-credentials }}

      - uses: Azure/login@v1
        with:
          creds: ${{ inputs.azure-credentials }}

      - name: Auth with gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_BASE64 }}

      - name: Install conduit plugin
        shell: bash
        run: |
          make install-konduit

      - name: Download csv
        shell: bash
        run: |
          bin/konduit.sh npq-registration-production-web -- psql -c "copy(select data from reports where identifier='dashboard') to STDOUT" | sed 's/\\n/\n/g' | sed '${/^$/d;}' > ~/data.csv

      - name: Upload csv to BigQuery
        shell: bash
        run: |
          bq load --autodetect --replace npq_registration.applications ~/data.csv
