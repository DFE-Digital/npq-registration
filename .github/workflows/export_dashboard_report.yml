name: Export dashboard report to BigQuery

on:
  workflow_dispatch:
  schedule:
    - cron:  '10 * * * *'

jobs:
  export:
    name: Export dashboard report to BigQuery

    runs-on: ubuntu-20.04
    container: google/cloud-sdk:latest
    environment:
      name: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Power Shell
        shell: bash
        run: |
          apt-get update
          apt-get install -y wget
          wget https://github.com/PowerShell/PowerShell/releases/download/v7.3.8/powershell_7.3.8-1.deb_amd64.deb
          dpkg -i powershell_7.3.8-1.deb_amd64.deb

      - name: Install Postgres
        shell: bash
        run: |
          apt-get update
          apt-get install -y postgresql

      - name: Install az (Azure CLI)
        shell: bash
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | bash

      - uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS credentials (sandbox, production)
        shell: bash
        run: az aks get-credentials -g s189p01-tsc-pd-rg -n s189p01-tsc-production-aks

      - name: Auth with gcloud
        uses: google-github-actions/setup-gcloud@v0
        with:
          service_account_key: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_BASE64 }}

      - name: Install conduit plugin
        shell: bash
        run: |
          make install-konduit

      - name: Install kubectl
        uses: azure/setup-kubectl@v3

      - name: Download csv
        shell: bash
        run: |
          bin/konduit.sh npq-registration-production-web -- psql -c "copy(select data from reports where identifier='dashboard') to STDOUT" | sed 's/\\n/\n/g' | sed 's/Running cleanup...//g' | sed '/^$/d' > /tmp/data.csv

      - name: Upload csv to BigQuery
        shell: bash
        run: |
          bq load --autodetect --replace npq_registration.applications /tmp/data.csv
